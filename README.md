# Tarantool

## Обзор Tarantool

### Введение

**Tarantool** — это платформа для вычислений в памяти, разработанная **Mail.ru Group** и выпущенная в open-source в 2010 году. Изначально Tarantool был создан для снижения затрат на поддержание крупных кластеров MySQL в проекте **"Мой Мир"**. С тех пор Tarantool активно используется в других продуктах компании: Почта, Реклама, Облако и других.

### История создания Tarantool

- **2008 год**: Начало разработки.
- **2010 год**: Выпуск Tarantool в open-source.
- **Цель разработки**: Уменьшение затрат на содержание и обслуживание кластера MySQL, который хранил профили пользователей.

## Эволюция Tarantool

1. ### In-Memory Cache

   - **Описание**: Быстрый кеш, хранящий данные в оперативной памяти для ускорения доступа.
   - **Проблема**: При перезапуске системы данные терялись, что снижало эффективность.

2. ### In-Memory Persistent Cache

   - **Решение проблемы**: Добавлена возможность персистентности — сохранения снимков данных на диск.
   - **Преимущества**: Быстрое восстановление данных после падения благодаря загрузке из сохраненных снимков.

3. ### In-Memory Cache with Replication

   - **Добавлена репликация**: Возможность собирать кластеры, повышая производительность и отказоустойчивость.
   - **Преимущества**: Если один инстанс падает, другой продолжает работу, обеспечивая доступность данных.

4. ### In-Memory Key/Value DB

   - **Переход к модели key/value**: Упрощение работы с данными и расширение функциональности.

5. ### Multiindex DB

   - **Множественные индексы**: Возможность создавать несколько индексов по различным полям.
   - **Преимущества**: Ускорение поиска и выборки данных.

6. ### In-Memory Multiindex DB with Lua Functions

   - **Интеграция Lua**: Возможность писать хранимые процедуры и выполнять более гибкую обработку данных.

7. ### In-Memory Multiindex DB with Lua Cooperative Runtime

   - **Кооперативный runtime**: Добавление возможности выполнять несколько операций одновременно.
   - **Преимущества**: Разгрузка основного потока и повышение эффективности.

8. ### In-Memory Multiindex DB with Lua App Server

   - **Сервер приложений на Lua**: Возможность создания полноценных приложений внутри Tarantool.

9. ### Hybrid Storage Multiindex DB with SQL and Lua App Server

   - **Гибридное хранилище**: Мультииндексное хранилище с ограниченными функциями SQL и сервером приложений на Lua.

## Tarantool сегодня

Tarantool является платформой in-memory вычислений с гибкой схемой данных для эффективного создания высоконагруженных приложений.

### Версии Tarantool

- **Open Source**:

  - **Доступность**: Размещен на [GitHub](https://github.com/tarantool) и распространяется по лицензии Simplified BSD.
  - **Компоненты**: Ядро, коннекторы, модули, библиотеки и топологии.
  - **Сообщество**: Около 150 контрибьюторов.
  - **Продукты**: Cartridge, Kubernetes Operator, Queue.

- **Enterprise**:

  - **Дополнения**: Поддержка решений, enterprise-продукты (Tarantool Data Grid, Master Data Manager, Channel Control).
  - **Услуги**: Обучение, консалтинг, кастомная разработка.

## Архитектура Tarantool

### Основные особенности

- **In-Memory**: Все данные находятся в оперативной памяти, что обеспечивает низкие задержки доступа (latency).

- **Один поток доступа к данным**: Предотвращает проблемы конкурентного доступа.

- **Персистентность**:

  - **Write Ahead Log (WAL)**: Последовательная запись изменений на диск для сохранения данных при сбоях.
  - **Snapshot**: Периодическое сохранение состояния базы данных для ускорения восстановления.

- **Индексы**: Поддержка различных типов индексов для ускорения поиска.

- **Репликация WAL**: Обеспечивает актуальность данных на всех узлах кластера.

### Компоненты архитектуры

- **Основной поток (транзакционный поток)**:

  - Управляет **ареной** — областью памяти, где хранятся данные.
  - Данные организованы в **спейсы** (аналог таблиц) и **таплы** (аналог строк).

- **Индексы**:

  - Строятся из данных в арене.
  - Ускоряют поиск и выборку данных.

- **Событийный цикл**:

  - **Файберы**: Легковесные нити исполнения, выполняющие операции с данными.
  - **Кооперативная многозадачность**: Задачи выполняются последовательно, передавая управление.

- **Сетевой поток (IPROTO)**:

  - Принимает внешние запросы, парсит и обрабатывает соединения.
  - Вызывает соответствующие файберы для выполнения запросов.

- **Write Ahead Log (WAL) поток**:

  - Записывает изменения данных на диск в файлы с расширением `.xlog`.

- **Snap Daemon**:

  - Создает консистентные **snapshot'ы** базы данных для ускорения восстановления.

- **Репликация**:

  - **Relay поток**: Передает изменения из WAL другим инстансам.
  - **Applier файбер**: На стороне реплики принимает и применяет изменения.

### Процесс запуска Tarantool

1. **Загрузка Snapshot**: Восстановление состояния данных из последнего снимка.

2. **Применение WAL**: Воспроизведение изменений из файлов логов, произошедших после создания snapshot.

3. **Достройка индексов**: Построение вторичных индексов в памяти.

4. **Запуск LuaJIT приложения**: Инициализация пользовательского приложения на Lua.

## Интеграция Lua

### Почему Lua?

- **Простота**: Скриптовый язык, понятный инженерам и легко изучаемый.

- **Эффективность**: Высокоэффективный **JIT-компилятор (LuaJIT)** приближает производительность скриптов к коду на C.

- **Близость к данным**: Возможность выполнять логику непосредственно рядом с данными, избегая сетевых запросов.

### Кооперативный Runtime

- **Файберы**: Легковесные нити, реализующие кооперативную многозадачность.

- **Многозадачность**: Каждая задача выполняется полностью, пока не передаст управление следующей.

- **Преимущества**: Повышение производительности и эффективности использования ресурсов.

## Сервер приложений

- **Событийный цикл с файберами**: Управление выполнением задач и обработкой событий.

- **Неблокирующие библиотеки**: Работа с сетью без блокировок, возможность быть сервером и клиентом.

- **Библиотеки для работы с данными**: Упрощают взаимодействие с базой данных.

- **Встроенные функции**: Предоставляют инструменты для работы с БД и разработке приложений.

## Сравнение Tarantool с другими СУБД

### In-Memory платформы

**Похожесть**:

- In-memory DB с runtime для приложений.
- Гибкая кластеризация.
- Решение бизнес-задач.

**Отличия**:

- Уникальная архитектура.
- Собственный набор инструментов и коннекторов.
- Широкий спектр бизнес-сценариев.

### Реляционные базы данных

**Похожесть**:

- Данные организованы в таблицах (спейсах).
- Поддержка индексов.
- Возможность работы с SQL*.

**Отличия**:

- **In-Memory хранение**: Более высокая производительность.
- **Гибкая схема данных**: Возможность комбинировать схематичный и документный подходы.
- **SQL не основной инструмент**: Основной язык — Lua.

\*SQL доступен в ограниченном виде.

### Key-Value хранилища

**Похожесть**:

- Режим работы key-value.
- Замена для Memcached и Redis.

**Отличия**:

- Поддержка вторичных индексов.
- Транзакции и итераторы.
- Богатый функционал для работы с данными.

### Документоориентированные базы данных

**Похожесть**:

- Хранение документов в формате MessagePack.
- Поддержка Avro Schema для работы с документами.

**Отличия**:

- Ограниченная индексация по документам.

### Колоночные базы данных

- **Tarantool не является колоночной базой данных**, но может дополнять их.

- **Batching**: Использование Tarantool в качестве агрегирующего слоя для накопления данных и передачи их в колоночную БД.

## Кейсы использования Tarantool

### Плохие сценарии

- **Аналитические запросы (OLAP)**:

  - Причина: Tarantool использует один поток, что неэффективно для аналитики.

### Хорошие сценарии

- **Высокочастотные микротранзакции (OLTP)**.
- **Профили пользователей**.
- **Счетчики и признаки**.
- **Кеш-прокси к данным**.
- **Брокеры очередей**.

**Причины**:

- Гарантированная низкая задержка (latency).
- Быстрый доступ к данным.
- Возможность работы рядом с данными без сетевых задержек.

## Поддерживаемые платформы

- **Операционные системы**:

  - Linux (x86/64)
  - BSD
  - macOS

- **Контейнеризация**:

  - Docker
  - Kubernetes (с помощью Kubernetes Operator)

- **Облачные среды**:

  - Совместим с различными облачными платформами.

- **ARM и IoT**:

  - Поддержка ARM-архитектуры (например, Raspberry Pi).

## Функциональность Tarantool

### Примитивы в Lua

- **Типы данных**:

  - Числа (`number`)
  - Строки (`string`)
  - Таблицы (`table`)
  - Булевы значения (`boolean`)

- **Управляющие конструкции**:

  - Условия (`if`, `else`)
  - Циклы (`for`, `while`)
  - Функции (`function`)

### Типы данных в Tarantool

- `string`: Строковый тип.
- `number`: Числовой тип.
- `integer`: Целые числа.
- `double`: Числа с плавающей точкой.
- `scalar`: Скалярные значения.
- `decimal`: Десятичные числа.
- `boolean`: Логический тип.
- `map`: Карты (ассоциативные массивы).
- `array`: Массивы.
- `uuid`: Универсальные уникальные идентификаторы.
- `datetime`: Тип для хранения даты и времени.
- `any`: Универсальный тип, принимающий любые значения.

### Примитивы хранения данных

- **Тапл (Tuple)**:

  - Кортеж данных, аналог строки в таблице.

- **Спейс (Space)**:

  - Коллекция таплов, аналог таблицы в SQL.
  - Имеет определенный **движок хранения (Engine)**:
    - `memtx`: In-memory движок для высокой производительности.
    - `vinyl`: Дисковый движок для хранения больших объемов данных.

- **Индексы**:

  - **Первичный индекс (Primary Index)**: Обязателен для каждого спейса.
  - **Вторичные индексы**: Дополнительные индексы для ускорения поиска.
  - **Композитные индексы**: Индексы по нескольким полям.

- **Типы индексов**:

  - **`tree (B⁺*)`**: Основной тип индекса для упорядоченного доступа.
  - **`hash`**: Для быстрого доступа по ключу.
  - **`bitmap`**: Для булевых значений и битовых полей.
  - **`rtree`**: Для геопространственных данных.
  - **`functional`**: Индексы на основе функций.
  - **`json path`**: Индексы по JSON-путям внутри документов.

## Заключение

**Tarantool** — универсальная платформа для высокопроизводительных приложений с низкой задержкой доступа к данным. Благодаря интеграции с Lua и гибким возможностям по хранению и обработке данных, Tarantool идеально подходит для задач, требующих быстрого доступа и высокой производительности.

---

Этот README предоставляет подробную информацию о Tarantool, его архитектуре, возможностях и случаях использования. Он поможет начать работу с Tarantool и понять, как эта платформа может быть полезна для ваших проектов.
